import streamlit as st
import requests
from bs4 import BeautifulSoup
import time
import threading
import xml.etree.ElementTree as ET
import random

# ---------------------------------------------------------
# [ê¸°ë³¸ ì„¤ì •] í˜ì´ì§€ ì œëª© ë° ì•„ì´ì½˜
# ---------------------------------------------------------
st.set_page_config(page_title="í™©ê¸ˆì•Œ ë´‡", page_icon="ğŸª¿")

# ---------------------------------------------------------
# [ê¸°ëŠ¥ 1] ë°ì´í„° ìˆ˜ì§‘ (ë‡Œ: ë¬´ì—‡ì„ ê°ì‹œí• ê¹Œ?)
# ---------------------------------------------------------
def get_google_trends():
    """êµ¬ê¸€ íŠ¸ë Œë“œ: í˜„ì¬ ì´ìŠˆ í‚¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸°"""
    rss_url = "https://trends.google.co.kr/trends/trendingsearches/daily/rss?geo=KR"
    try:
        response = requests.get(rss_url)
        root = ET.fromstring(response.content)
        trends = [item.find('title').text for item in root.findall('.//item')]
        return trends[:10]
    except:
        return ["íŠ¹ê°€", "ì˜¤ë¥˜", "ëŒ€ë€"]

def get_naver_shopping_best():
    """ë„¤ì´ë²„ ì‡¼í•‘: í˜„ì¬ ì˜ íŒ”ë¦¬ëŠ” ë””ì§€í„¸/ê°€ì „ ì œí’ˆ ê°€ì ¸ì˜¤ê¸°"""
    url = "https://search.shopping.naver.com/best/category/click?categoryCategoryId=50000003&viewType=list&sort=popular"
    headers = {'User-Agent': 'Mozilla/5.0'}
    try:
        response = requests.get(url, headers=headers)
        soup = BeautifulSoup(response.text, 'html.parser')
        # ë„¤ì´ë²„ ì‡¼í•‘ í´ë˜ìŠ¤ëª…ì€ ë³€ë™ ê°€ëŠ¥ì„±ì´ ìˆì–´ imageTitle_titleì„ í¬í•¨í•˜ëŠ” div ê²€ìƒ‰
        items = soup.find_all('div', class_=lambda x: x and 'imageTitle_title' in x)
        
        keywords = []
        for item in items:
            # ê²€ìƒ‰ ì •í™•ë„ë¥¼ ìœ„í•´ ìƒí’ˆëª…ì˜ ì• 2ë‹¨ì–´ë§Œ ì¶”ì¶œ (ì˜ˆ: ì‚¼ì„±ì „ì ê°¤ëŸ­ì‹œë¶4 -> ì‚¼ì„±ì „ì ê°¤ëŸ­ì‹œë¶4)
            full_name = item.text
            short_name = " ".join(full_name.split()[:2])
            keywords.append(short_name)
        return list(set(keywords))[:10]
    except:
        return ["ì•„ì´í°", "ê°¤ëŸ­ì‹œ", "ë…¸íŠ¸ë¶"]

# ---------------------------------------------------------
# [ê¸°ëŠ¥ 2] ë´‡ ì—”ì§„ (ëˆˆ: í•«ë”œ ì°¾ê¸° & ì…: ì•Œë¦¼ ë³´ë‚´ê¸°)
# ---------------------------------------------------------
def send_telegram_message(token, chat_id, message):
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    params = {"chat_id": chat_id, "text": message}
    try:
        requests.get(url, params=params)
    except:
        pass

def crawling_job(token, chat_id, target_url, mode, manual_kws, log_container):
    if 'sent_titles' not in st.session_state:
        st.session_state['sent_titles'] = []

    while st.session_state['is_running']:
        try:
            # 1. ëª¨ë“œì— ë”°ë¼ í‚¤ì›Œë“œ ìë™ ì„ ì •
            if mode == "ë„¤ì´ë²„ ì‡¼í•‘ ë­í‚¹ (ìˆ˜ìµ)":
                current_keywords = get_naver_shopping_best()
                icon = "ğŸ›ï¸"
            elif mode == "êµ¬ê¸€ íŠ¸ë Œë“œ (ì´ìŠˆ)":
                current_keywords = get_google_trends()
                icon = "ğŸŒŠ"
            else:
                current_keywords = manual_kws
                icon = "âœï¸"

            # 2. ë¡œê·¸ ì—…ë°ì´íŠ¸
            kws_str = ", ".join(current_keywords[:3])
            log_container.info(f"[{time.strftime('%H:%M:%S')}] {icon} íƒ€ê²ŸíŒ… ì¤‘: {kws_str} ë“± {len(current_keywords)}ê°œ")

            # 3. ì‚¬ì´íŠ¸ í¬ë¡¤ë§ (í•«ë”œ ê²Œì‹œíŒ íƒìƒ‰)
            headers = {'User-Agent': 'Mozilla/5.0'}
            response = requests.get(target_url, headers=headers)
            soup = BeautifulSoup(response.text, 'html.parser')
            
            # â€» ì¤‘ìš”: ì‚¬ì´íŠ¸ë§ˆë‹¤ íƒœê·¸ê°€ ë‹¤ë¦„. ì•„ë˜ëŠ” ë„¤ì´ë²„ ë‰´ìŠ¤ ì˜ˆì‹œ (ì‹¤ì „ì—” ë½ë¿Œ ë“± íƒœê·¸ë¡œ ë³€ê²½ í•„ìš”)
            articles = soup.select("dt > a") 

            for article in articles:
                title = article.text.strip()
                link = article.get('href')

                for kw in current_keywords:
                    # ë„ì–´ì“°ê¸° ë¬´ì‹œí•˜ê³  ë¹„êµ
                    if kw.replace(" ", "") in title.replace(" ", "") and title not in st.session_state['sent_titles']:
                        msg = f"ğŸ”¥ [ì‹¬ë´¤ë‹¤! ({kw})]\n\nì œëª©: {title}\në§í¬: {link}"
                        send_telegram_message(token, chat_id, msg)
                        st.session_state['sent_titles'].append(title)
            
            # 4. ì°¨ë‹¨ ë°©ì§€ íœ´ì‹ (60ì´ˆ + ëœë¤)
            time.sleep(60 + random.randint(1, 20))

        except Exception as e:
            log_container.error(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
            time.sleep(60)

# ---------------------------------------------------------
# [í™”ë©´] ì›¹ì‚¬ì´íŠ¸ UI
# ---------------------------------------------------------
st.title("ğŸª¿ í™©ê¸ˆì•Œ ìë™ ë´‡")
st.markdown("ìë™ìœ¼ë¡œ ëˆ ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì°¾ì•„ í•«ë”œì„ ê°ì‹œí•©ë‹ˆë‹¤.")

with st.sidebar:
    st.header("âš™ï¸ ì„¤ì •")
    input_token = st.text_input("í…”ë ˆê·¸ë¨ í† í°", type="password")
    input_chat_id = st.text_input("ì±„íŒ… ID")
    # ì•„ë˜ URLì„ 'ë½ë¿Œ ê²Œì‹œíŒ'ì´ë‚˜ 'ë”œë°”ë‹¤' URLë¡œ ë°”ê¾¸ë©´ ë” íš¨ê³¼ê°€ ì¢‹ìŠµë‹ˆë‹¤.
    input_url = st.text_input("ê°ì‹œ URL", value="https://news.naver.com/main/list.naver?mode=LS2D&mid=shm&sid1=105&sid2=230")

col1, col2 = st.columns([2, 1])
with col1:
    mode = st.radio("ëª¨ë“œ ì„ íƒ", ["ë„¤ì´ë²„ ì‡¼í•‘ ë­í‚¹ (ìˆ˜ìµ)", "êµ¬ê¸€ íŠ¸ë Œë“œ (ì´ìŠˆ)", "ìˆ˜ë™ ì…ë ¥"])
    manual_kws = []
    if mode == "ìˆ˜ë™ ì…ë ¥":
        manual_kws = st.text_area("í‚¤ì›Œë“œ (ì‰¼í‘œ êµ¬ë¶„)", "íŠ¹ê°€, ì˜¤ë¥˜").split(",")

with col2:
    st.write("") # ì—¬ë°±
    st.write("") 
    if 'is_running' not in st.session_state:
        st.session_state['is_running'] = False
        
    if st.button("ğŸš€ ì‹œì‘", type="primary", use_container_width=True):
        if not input_token:
            st.error("í† í° í•„ìš”!")
        elif not st.session_state['is_running']:
            st.session_state['is_running'] = True
            t = threading.Thread(target=crawling_job, args=(input_token, input_chat_id, input_url, mode, manual_kws, st.empty()))
            t.start()
            st.toast("ì‚¬ëƒ¥ ì‹œì‘!")
            
    if st.button("ğŸ›‘ ì¤‘ì§€", use_container_width=True):
        st.session_state['is_running'] = False
        st.info("ì¤‘ì§€ë¨.")

st.divider()
st.caption("ì‹¤ì‹œê°„ ë¡œê·¸")
# ë´‡ì´ ì‹¤í–‰ë˜ë©´ì„œ ì´ ë¹ˆ ê³µê°„ì— ë¡œê·¸ë¥¼ ì¶œë ¥í•¨
st.empty()